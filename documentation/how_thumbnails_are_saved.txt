How Preview Images Are Saved in Hey Hannah App
==============================================

Image Saving Process Overview

1. Capture Setup - Always-Available Hidden Container
---------------------------------------------------
The app maintains a hidden capture container that's always rendered but invisible (lines 1463-1517 in App.js):

```javascript
{/* Always-available hidden capture container for saving */}
<View style={[styles.captureContainer, {
  position: "absolute",
  opacity: 0,           // Always invisible
  pointerEvents: "none", // Can't be interacted with
  zIndex: -1000,        // Behind everything
  backgroundColor: currentBackgroundColor,
}]}>
  <View ref={captureTextRef}>  {/* This is what gets captured */}
    <Text style={[/* styled with current colors, fonts, etc */]}>
      {text}
    </Text>
    <Text style={styles.watermark}>
      made with Hey Hannah
    </Text>
  </View>
</View>
```

2. Capture Trigger
------------------
When the user wants to save an image, the app calls saveToGallery() which:

1. Captures the hidden container using captureRef(captureTextRef.current):
```javascript
const uri = await captureRef(captureTextRef.current, {
  format: "jpg",
  quality: 1.0,
  result: "tmpfile",
});
```

2. Creates the image file as a JPG with high quality to a temporary location

3. File Storage
---------------
The captured image is then saved permanently:

1. Generate meaningful filename using generateFilename() utility:
   - Based on text content (first 40 characters, cleaned)
   - Includes date in DD-MM-YYYY format
   - Example: hello-world-25-09-2025.jpg
   - Handles duplicates by adding incrementing numbers

2. Copy to permanent location:
```javascript
const permanentPath = galleryDir + filename;
await FileSystem.copyAsync({
  from: uri,          // temporary capture
  to: permanentPath,  // permanent gallery location
});
```

3. Create metadata object with all the styling information:
```javascript
const versionInfo = getVersionInfo();

// Create structured color info objects using new system
const backgroundColorInfo = createColorInfo(
  isShadeSelection(selectedShadeColor, selectedShadeType, "background"),
  bgColorModeSelection,
  backgroundColorIndex,
  highlightedRow,
  highlightedColumn,
  selectedShadeColor,
  selectedShadeType,
  "background"
);

const textColorInfo = createColorInfo(
  isShadeSelection(selectedShadeColor, selectedShadeType, "text"),
  textColorModeSelection,
  textColorIndex,
  highlightedRow,
  highlightedColumn,
  selectedShadeColor,
  selectedShadeType,
  "text"
);

const metadata = {
  id: timestamp,
  filename,
  path: permanentPath,
  text: text,                    // Full text content
  backgroundColorInfo: backgroundColorInfo, // New structured color info
  textColorInfo: textColorInfo,  // New structured color info
  // Legacy fields for backward compatibility
  backgroundColor: currentBackgroundColor,  // Actual hex color (e.g., "#FF3333")
  backgroundPalette: getPaletteFromInfo(backgroundColorInfo), // Complete palette array used for background
  textColor: currentTextColor,   // Actual hex color
  textPalette: getPaletteFromInfo(textColorInfo), // Complete palette array used for text
  alignment,                    // 0=left, 1=center, 2=right
  fontFamily: FONT_FAMILIES[fontFamily], // Font family name (e.g., "System", "Courgette_400Regular")
  fontSize,                     // Calculated font size
  previewHeight,               // Calculated height for this image
  isFavorited: false,
  createdAt: new Date().toISOString(),
  appVersion: versionInfo.appVersion,  // App version that created this image
  buildNumber: versionInfo.buildNumber, // Build number that created this image
  os: "ios",                    // Operating system platform
};
```

4. Gallery Database Update
--------------------------
The metadata is stored in a JSON file:
- Location: FileSystem.documentDirectory + "gallery/metadata.json"
- Structure: Array of image metadata objects
- Sorting: New images added at beginning (newest first)

5. Key Features
---------------

Automatic Saving: 
- Images are auto-saved when switching between gallery/editor
- Images are auto-saved before creating new images
- No manual save button needed

Smart Filenames:
- Based on actual text content
- Include dates for organization
- Handle duplicates intelligently

Complete Style Preservation:
- New structured color info system for precise color restoration
- Backward compatibility with legacy hex-based storage
- Font family names stored as strings (future-proof against font array changes)
- Font settings, alignment, text size all preserved
- Preview height calculated and saved for consistent reproduction
- Complete palette context preserved for perfect color cycling restoration

Version Tracking:
- App version and build number recorded for each image creation and edit
- Enables debugging and compatibility tracking across app updates
- Helps identify which version of the app created or last modified each image

Two Storage Systems:
- Image files: Actual JPG files stored in gallery directory
- Metadata: JSON file with all the styling and content information

6. Rendering Logic
------------------
When displaying gallery thumbnails, the system:
- Uses the saved backgroundColor and textColor hex values directly
- Falls back to COLOR_VALUES lookup for legacy images
- Scales font size down by 0.21x for thumbnail display
- Uses all saved styling properties to ensure accurate previews

This architecture ensures that every saved image is a perfect snapshot of how the text appeared when saved, with all styling preserved both in the visual file and the metadata for reconstruction.

7. Complete Metadata Example
----------------------------
Here's what a typical saved image metadata object looks like with the new color info system:

```json
{
  "id": 1695648151234,
  "filename": "hello-world-25-09-2025.jpg",
  "path": "/path/to/gallery/hello-world-25-09-2025.jpg",
  "text": "Hello World!",
  "backgroundColorInfo": {
    "shade": false,
    "paletteIndex": 2,
    "activeColor": 5
  },
  "textColorInfo": {
    "shade": true,
    "colorIndex": 7,
    "rowOrColumn": "column",
    "arrayNumber": 3,
    "activeColor": 2
  },
  "alignment": 1,
  "fontFamily": "Courgette_400Regular",
  "fontSize": 28,
  "previewHeight": 450,
  "isFavorited": false,
  "createdAt": "2025-09-25T12:34:56.789Z",
  "appVersion": "1.2.0",
  "buildNumber": "11",
  "os": "ios"
}
```

8. New Color Info System
------------------------
The app now uses a structured color info system that precisely captures how colors were selected:

**For Regular Palette Colors:**
```json
{
  "shade": false,
  "paletteIndex": 2,    // Which of the 8 base palettes (0-7)
  "activeColor": 5      // Which position in that palette (0-7)
}
```

**For Shade Colors:**
```json
{
  "shade": true,
  "colorIndex": 7,      // Which shade array (0=red, 1=orange, ..., 7=black)
  "rowOrColumn": "column", // Whether a row or column was selected
  "arrayNumber": 3,     // Which row/column number (0-7)
  "activeColor": 2      // Position within that row/column (0-7)
}
```

**Field Meanings:**
- `shade`: Boolean indicating if this is a shade selection
- `colorIndex`: For shades, which of the 8 shade arrays (RED_SHADES, ORANGE_SHADES, etc.)
- `paletteIndex`: For regular colors, which of the 8 base palettes
- `rowOrColumn`: For shades, whether user selected a row or column
- `arrayNumber`: For shades, which specific row/column (0-7)
- `activeColor`: Position within the selected palette/row/column (0-7)

**Color Restoration Process:**
1. Check if `shade` is true or false
2. For regular colors: Use `ALL_COLORS[paletteIndex][activeColor]`
3. For shade colors: 
   - Get shade array: `ALL_SHADES[colorIndex]`
   - If row: position = `arrayNumber * 8 + activeColor`
   - If column: position = `activeColor * 8 + arrayNumber`
   - Return `shadeArray[position]`

**Benefits:**
- No reverse engineering of hex values
- Direct mapping to user selections
- Precise restoration of highlighting state
- Future-proof against color system changes
- Clean, structured metadata format

Font Family Information:
- fontFamily: Font family name stored as string (e.g., "System", "Courgette_400Regular")
- Future-proof against font array reordering or additions
- Calculated font index when needed by searching FONT_FAMILIES array
- Maintains backward compatibility with older index-based format

Platform and Version Information Fields:
- os: Operating system platform ("ios" for iPhone/iPad)
- appVersion: Semantic version of the app (matches app.json version)
- buildNumber: iOS build number (matches app.json ios.buildNumber)
- Updated on both image creation and editing for full audit trail

Optimized Storage Strategy:
The app uses intelligent storage approaches for maximum reliability:

Color Storage:
1. Hex colors (backgroundColor, textColor): Exact visual preservation
2. Complete palettes (backgroundPalette, textPalette): Full color context
3. Color indices calculated dynamically from hex color position in palette

Font Storage:
1. Font family names (fontFamily): Future-proof string storage
2. Font indices calculated dynamically from FONT_FAMILIES array lookup

This ensures that images can be:
- Displayed perfectly using hex colors
- Edited naturally with calculated indices and saved palettes
- Restored with complete color cycling functionality
- Preserved against future app changes
